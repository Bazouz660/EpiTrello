name: CD

on:
  push:
    branches: [main, dev]
    paths-ignore:
      - '**.md'
      - 'doc/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de dÃ©ploiement'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - production

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  # ============================================
  # JOB 1: Set environment variables
  # ============================================
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      backend_app: ${{ steps.set-env.outputs.backend_app }}
      frontend_app: ${{ steps.set-env.outputs.frontend_app }}
      backend_url: ${{ steps.set-env.outputs.backend_url }}
      frontend_url: ${{ steps.set-env.outputs.frontend_url }}

    steps:
      - name: Determine environment
        id: set-env
        run: |
          # Determine environment from branch or manual input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref_name }}" == "main" ]; then
            ENV="production"
          else
            ENV="dev"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          if [ "$ENV" == "production" ]; then
            echo "backend_app=epitrello-backend" >> $GITHUB_OUTPUT
            echo "frontend_app=epitrello-frontend" >> $GITHUB_OUTPUT
            echo "backend_url=https://epitrello-backend.fly.dev" >> $GITHUB_OUTPUT
            echo "frontend_url=https://epitrello-frontend.fly.dev" >> $GITHUB_OUTPUT
          else
            echo "backend_app=epitrello-backend-dev" >> $GITHUB_OUTPUT
            echo "frontend_app=epitrello-frontend-dev" >> $GITHUB_OUTPUT
            echo "backend_url=https://epitrello-backend-dev.fly.dev" >> $GITHUB_OUTPUT
            echo "frontend_url=https://epitrello-frontend-dev.fly.dev" >> $GITHUB_OUTPUT
          fi

      - name: Print environment info
        run: |
          echo "ğŸŒ Environment: ${{ steps.set-env.outputs.environment }}"
          echo "ğŸ“¦ Backend App: ${{ steps.set-env.outputs.backend_app }}"
          echo "ğŸ–¥ï¸ Frontend App: ${{ steps.set-env.outputs.frontend_app }}"

  # ============================================
  # JOB 2: Tests (gate before deployment)
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run linters
        run: npm run lint

      - name: Run tests
        run: npm test

  # ============================================
  # JOB 3: Deploy Backend to Fly.io
  # ============================================
  deploy-backend:
    name: Deploy Backend (${{ needs.setup.outputs.environment }})
    needs: [setup, test]
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: ${{ needs.setup.outputs.backend_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Backend to Fly.io
        working-directory: ./backend
        run: |
          flyctl deploy --remote-only \
            --app ${{ needs.setup.outputs.backend_app }} \
            --env CLIENT_URL=${{ needs.setup.outputs.frontend_url }} \
            --ha=false

      - name: Verify Backend Health
        run: |
          echo "Waiting for backend to be healthy..."
          sleep 10
          curl -f ${{ needs.setup.outputs.backend_url }}/api/health || exit 1
          echo "âœ… Backend is healthy!"

  # ============================================
  # JOB 4: Deploy Frontend to Fly.io
  # ============================================
  deploy-frontend:
    name: Deploy Frontend (${{ needs.setup.outputs.environment }})
    needs: [setup, test, deploy-backend]
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: ${{ needs.setup.outputs.frontend_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Frontend to Fly.io
        working-directory: ./frontend
        run: |
          flyctl deploy --remote-only \
            --app ${{ needs.setup.outputs.frontend_app }} \
            --build-arg VITE_API_URL=${{ needs.setup.outputs.backend_url }}/api \
            --ha=false

      - name: Verify Frontend
        run: |
          echo "Waiting for frontend to be ready..."
          sleep 10
          curl -f ${{ needs.setup.outputs.frontend_url }} || exit 1
          echo "âœ… Frontend is live!"

  # ============================================
  # JOB 5: Summary
  # ============================================
  deployment-summary:
    name: Deployment Summary
    needs: [setup, deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Print Summary
        run: |
          echo "ğŸš€ Deployment Complete!"
          echo ""
          echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"
          echo "ğŸ“¦ Backend:  ${{ needs.setup.outputs.backend_url }}"
          echo "ğŸ–¥ï¸  Frontend: ${{ needs.setup.outputs.frontend_url }}"
          echo "ğŸ”— API:      ${{ needs.setup.outputs.backend_url }}/api"
          echo ""
          echo "ğŸ“Š Health Check: ${{ needs.setup.outputs.backend_url }}/api/health"
          echo "ğŸ”— API:      https://epitrello-backend.fly.dev/api"
          echo ""
          echo "ğŸ“Š Health Check: https://epitrello-backend.fly.dev/api/health"
